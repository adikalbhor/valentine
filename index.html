/******************** MOBILE OPTIMIZATION SETTINGS ********************/
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// Animation scaling for mobile
const FIREWORK_SCALE   = isMobile ? 0.6 : 1.0;
const CONFETTI_SCALE   = isMobile ? 0.55 : 1.0;
const HEART_SCALE      = isMobile ? 0.75 : 1.0;
const HEART_INTERVAL   = isMobile ? 450 : 300; // fewer hearts on phones
const TRAIL_HEART_SIZE = isMobile ? "14px" : "18px";

/******************** ELEMENTS ************************/
const first = document.getElementById("firstScreen");
const second = document.getElementById("secondScreen");
const yesBtn = document.getElementById("yesBtn");
const noBtn = document.getElementById("noBtn");
const msg = document.getElementById("message");
const neon = document.getElementById("neonLoveText");
const dinnerBtn = document.getElementById("dinner");
const coffeeBtn = document.getElementById("coffee");
const modal = document.getElementById("resultModal");
const title = document.getElementById("resultTitle");
const quote = document.getElementById("resultQuote");
const modalClose = document.getElementById("modalClose");

const fireworksCanvas = document.getElementById("fireworksCanvas");
const confettiCanvas = document.getElementById("confettiCanvas");
const bokehCanvas = document.getElementById("bokehLayer");
const fctx = fireworksCanvas.getContext("2d");
const cctx = confettiCanvas.getContext("2d");
const bctx = bokehCanvas.getContext("2d");

/******************** RESIZE CANVASES ********************/
function resizeCanvases(){
    const DPR = isMobile ? 1.0 : devicePixelRatio;
    [fireworksCanvas, confettiCanvas, bokehCanvas].forEach(cv=>{
        cv.width = innerWidth * DPR;
        cv.height = innerHeight * DPR;
        const ctx = cv.getContext("2d");
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    });
}
resizeCanvases();
addEventListener("resize", resizeCanvases);

/******************** FLOATING HEARTS (reduced on mobile) ********************/
setInterval(() => {
    let h = document.createElement("div");
    h.className = "heart";
    h.textContent = "ðŸ’–";
    h.style.left = Math.random() * innerWidth + "px";
    h.style.fontSize = (Math.random()*18 + 20) * HEART_SCALE + "px";
    document.body.appendChild(h);
    setTimeout(() => h.remove(), 4800);
}, HEART_INTERVAL);

/******************** HEART TRAIL (smaller on mobile) ********************/
(function heartTrail(){
    const EMOJI = ["ðŸ’—","ðŸ’–","â¤ï¸","ðŸ’•"];
    function puff(x,y){
        const el = document.createElement("div");
        el.className = "trail-heart";
        el.textContent = EMOJI[Math.floor(Math.random()*EMOJI.length)];
        el.style.position = "fixed";
        el.style.left = (x - 6) + "px";
        el.style.top  = (y - 6) + "px";
        el.style.fontSize = TRAIL_HEART_SIZE;
        el.style.animation = "trailPop 1s ease-out forwards";
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 900);
    }
    window.addEventListener("mousemove", e => puff(e.clientX, e.clientY));
    window.addEventListener("touchmove", e => {
        const t = e.touches[0];
        if (t) puff(t.clientX, t.clientY);
    }, {passive:true});
})();

/******************** FIREWORKS (scaled down on mobile) ********************/
let fireworks = [];
function spawnFirework(x, y, hue){
    const count = isMobile ? 30 : 70;
    for(let i=0;i<count;i++){
        const angle = (Math.PI * 2 * i) / count;
        const speed = (Math.random()*3 + 2) * FIREWORK_SCALE;
        fireworks.push({
            x, y,
            vx: Math.cos(angle)*speed,
            vy: Math.sin(angle)*speed,
            life: Math.random()*40 + 40,
            hue: hue || Math.floor(Math.random()*360),
            alpha: 1
        });
    }
}

function drawFireworks(){
    fctx.globalCompositeOperation = "destination-out";
    fctx.fillStyle = "rgba(0,0,0,0.25)";
    fctx.fillRect(0,0,innerWidth,innerHeight);
    fctx.globalCompositeOperation = "lighter";

    fireworks.forEach(p=>{
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.015 * FIREWORK_SCALE;
        p.life--;
        p.alpha = Math.max(0, p.life/90);

        fctx.beginPath();
        fctx.fillStyle = `hsla(${p.hue}, 100%, 60%, ${p.alpha})`;
        fctx.arc(p.x, p.y, 2 * FIREWORK_SCALE, 0, Math.PI*2);
        fctx.fill();
    });

    fireworks = fireworks.filter(p => p.life > 0);
    requestAnimationFrame(drawFireworks);
}
drawFireworks();

/******************** CONFETTI (scaled down on mobile) ********************/
let confetti = [];
function burstConfetti(x,y){
    const qty = isMobile ? 60 : 140;
    for(let i=0;i<qty;i++){
        confetti.push({
            x, y,
            vx: (Math.random()-0.5)*6 * CONFETTI_SCALE,
            vy: (Math.random()-1.2)*5 * CONFETTI_SCALE,
            size: (Math.random()*6 + 3) * CONFETTI_SCALE,
            rot: Math.random()*Math.PI,
            vr: (Math.random()-0.5)*0.2,
            g: 0.05 + Math.random()*0.03,
            color: ["#ff2ebd","#ff6aa5","#ffd1e8","#ff9ecb"][Math.floor(Math.random()*4)],
            life: 140 + Math.random()*40
        });
    }
}

function drawConfetti(){
    cctx.clearRect(0,0,innerWidth,innerHeight);
    confetti.forEach(p=>{
        p.x += p.vx;
        p.y += p.vy;
        p.vy += p.g;
        p.rot += p.vr;
        p.life--;

        cctx.save();
        cctx.translate(p.x, p.y);
        cctx.rotate(p.rot);
        cctx.fillStyle = p.color;
        cctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
        cctx.restore();
    });

    confetti = confetti.filter(p => p.life > 0 && p.y < innerHeight + 40);
    requestAnimationFrame(drawConfetti);
}
drawConfetti();

/******************** YES BUTTON CLICK (mobile friendly) ********************/
yesBtn.onclick = () => {
    document.getElementById("question").style.display="none";
    noBtn.style.display="none";

    msg.style.display="block";
    neon.style.display="block";

    const music = new Audio("https://cdn.pixabay.com/audio/2023/02/14/audio_70f0f7c4df.mp3");
    music.volume = 0.4;
    music.play().catch(()=>{});

    const cx = innerWidth/2, cy = innerHeight/2;

    spawnFirework(cx, cy, 330);
    spawnFirework(cx, cy-80, 300);
    burstConfetti(cx, cy-40);

    // Page transition â†’ smoother on mobile with fade
    setTimeout(() => {
        msg.style.display="none";
        neon.style.display="none";
        first.style.display="none";
        second.style.opacity = "0";
        second.style.display="flex";

        // Fade-in animation for mobile
        setTimeout(() => {
            second.style.transition = "opacity 1.2s ease";
            second.style.opacity = "1";
        }, 80);

    }, 6000);
};

/******************** PAGE 2 OPTIONS ********************/
dinnerBtn.onclick = () => {
    title.textContent="Dinner Date ðŸ½ï¸";
    quote.textContent="Letâ€™s enjoy a romantic dinner full of love, warmth & smiles.";
    modal.style.display="flex";
    coffeeBtn.style.display="none";
};

coffeeBtn.onclick = () => {
    title.textContent="Coffee Date â˜•";
    quote.textContent="Warm coffee + warm conversation = the perfect moment with you â¤ï¸";
    modal.style.display="flex";
    dinnerBtn.style.display="none";
};

modalClose.onclick = () => {
    modal.style.display="none";
    dinnerBtn.style.display="";
    coffeeBtn.style.display="";
};
